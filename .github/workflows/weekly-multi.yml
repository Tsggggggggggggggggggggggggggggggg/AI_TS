name: AI Weekly Digest (Multi-Theme)

on:
  schedule:
    - cron: '0 9 * * 1'            # 每周一 09:00 UTC 自动运行
  workflow_dispatch:               # 手动运行
    inputs:
      theme:
        description: 'Theme to run (ai / business / psych / design / all)'
        required: false
        default: 'all'

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        theme: ${{ fromJSON(github.event.inputs.theme == 'all' && '["ai","business","psych","design"]' || format('["{0}"]', github.event.inputs.theme)) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 调试：确认文件/环境无误
      - name: Debug workspace
        run: |
          echo "Python:" && python -V
          echo "CWD:" && pwd
          echo "List repo root:" && ls -la
          echo "Theme=${{ matrix.theme }}"
          echo "---- requirements.txt ----"
          cat requirements.txt || true

      # 稳定安装依赖（禁用缓存 + 打印版本）
      - name: Install deps
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install --upgrade --no-cache-dir -r requirements.txt
          echo "---- pip freeze ----"
          pip freeze

      # 运行抓取&生成（会产出 output/weekly_digest_<theme>_bilingual.md）
      - name: Run script for ${{ matrix.theme }}
        env:
          THEME: ${{ matrix.theme }}
        run: |
          python fetch_and_summarize.py

      # 上传单主题产物
      - name: Upload artifact (${{ matrix.theme }})
        uses: actions/upload-artifact@v4
        with:
          name: weekly_digest_${{ matrix.theme }}
          path: output/weekly_digest_${{ matrix.theme }}*.md

  merge:
    name: Merge all themes to one bilingual report
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: merged_inputs
          pattern: weekly_digest_*
          merge-multiple: true

      - name: Merge to one bilingual report (Chinese section titles)
        shell: bash
        run: |
          python <<'PY'
          import os, glob, datetime
          from datetime import timezone, timedelta

          os.makedirs("output", exist_ok=True)

          # 主题顺序 & 中文分区标题
          ORDER = ["ai","business","psych","design"]
          TITLES = {
              "ai": "AI 快讯",
              "business": "商业观察",
              "psych": "心理与人文",
              "design": "设计灵感",
          }

          def pick_file(theme):
              # 我们主要产出 *_bilingual.md；保留兜底
              for suf in ["_bilingual.md","_zh.md","_en.md"]:
                  cand = glob.glob(f"merged_inputs/**/weekly_digest_{theme}{suf}", recursive=True)
                  if cand:
                      return sorted(cand)[-1]
              return None

          def fmt(dt):
              bj = dt.astimezone(datetime.timezone(datetime.timedelta(hours=8)))
              return bj.strftime("%Y-%m-%d %H:%M")

          end = datetime.datetime.now(datetime.timezone.utc)
          start = end - datetime.timedelta(days=7)

          header = [
              f"# 多主题一周总览（中英双语） · {fmt(start)} ~ {fmt(end)}",
              "> 分区：AI 快讯 / 商业观察 / 心理与人文 / 设计灵感",
              ""
          ]

          parts = ["\n".join(header)]

          for theme in ORDER:
              f = pick_file(theme)
              if not f:
                  print(f"[warn] no report found for {theme}")
                  continue

              # 读入单主题报告
              with open(f, "r", encoding="utf-8") as fh:
                  txt = fh.read().strip()

              # 替换一级标题为中文分区标题；若无标题则直接插入
              lines = txt.splitlines()
              sec_title = f"## {TITLES.get(theme, theme.upper())}"
              if lines and lines[0].startswith("# "):
                  lines[0] = sec_title
              else:
                  lines.insert(0, sec_title)

              parts.append("\n".join(lines))
              parts.append("\n---\n")  # 分隔线

          merged = "\n".join(parts).strip() + "\n\n*Generated by AI Weekly Digest via GitHub Actions*"
          out = "output/weekly_digest_ALL_bilingual.md"
          with open(out, "w", encoding="utf-8") as fw:
              fw.write(merged)
          print(f"Merged -> {out}")
          PY

      - name: Upload merged report
        uses: actions/upload-artifact@v4
        with:
          name: weekly_digest_ALL
          path: output/weekly_digest_ALL_bilingual.md
